# Comparing `tmp/opentf_toolkit_nightly-0.50.0.dev634-py3-none-any.whl.zip` & `tmp/opentf_toolkit_nightly-0.50.0.dev637-py3-none-any.whl.zip`

## zipinfo {}

```diff
@@ -1,50 +1,54 @@
-Zip file size: 74270 bytes, number of entries: 48
--rw-r--r--  2.0 unx    40272 b- defN 23-Jul-13 15:29 opentf/commons/__init__.py
--rw-r--r--  2.0 unx    18980 b- defN 23-Jul-13 15:29 opentf/commons/expressions.py
--rw-r--r--  2.0 unx     5521 b- defN 23-Jul-13 15:29 opentf/commons/selectors.py
--rw-r--r--  2.0 unx        0 b- defN 23-Jul-13 15:29 opentf/schemas/__init__.py
--rw-rw-rw-  2.0 unx     2105 b- defN 23-Jul-13 15:29 opentf/schemas/abac.opentestfactory.org/v1alpha1/Policy.json
--rw-rw-rw-  2.0 unx     1230 b- defN 23-Jul-13 15:29 opentf/schemas/opentestfactory.org/v1alpha1/AgentRegistration.json
--rw-rw-rw-  2.0 unx     1366 b- defN 23-Jul-13 15:29 opentf/schemas/opentestfactory.org/v1alpha1/AllureCollectorOutput.json
--rw-rw-rw-  2.0 unx     1239 b- defN 23-Jul-13 15:29 opentf/schemas/opentestfactory.org/v1alpha1/ChannelHandlerHooks.json
--rw-rw-rw-  2.0 unx     2174 b- defN 23-Jul-13 15:29 opentf/schemas/opentestfactory.org/v1alpha1/EventBusConfig.json
--rw-rw-rw-  2.0 unx     2702 b- defN 23-Jul-13 15:29 opentf/schemas/opentestfactory.org/v1alpha1/ExecutionCommand.json
--rw-rw-rw-  2.0 unx     1347 b- defN 23-Jul-13 15:29 opentf/schemas/opentestfactory.org/v1alpha1/ExecutionError.json
--rw-rw-rw-  2.0 unx     3050 b- defN 23-Jul-13 15:29 opentf/schemas/opentestfactory.org/v1alpha1/ExecutionResult.json
--rw-rw-rw-  2.0 unx     1754 b- defN 23-Jul-13 15:29 opentf/schemas/opentestfactory.org/v1alpha1/GeneratorCommand.json
--rw-rw-rw-  2.0 unx     6633 b- defN 23-Jul-13 15:29 opentf/schemas/opentestfactory.org/v1alpha1/GeneratorResult.json
--rw-rw-rw-  2.0 unx     3790 b- defN 23-Jul-13 15:29 opentf/schemas/opentestfactory.org/v1alpha1/Notification.json
--rw-rw-rw-  2.0 unx     2803 b- defN 23-Jul-13 15:29 opentf/schemas/opentestfactory.org/v1alpha1/PluginMetadata.json
--rw-rw-rw-  2.0 unx     2875 b- defN 23-Jul-13 15:29 opentf/schemas/opentestfactory.org/v1alpha1/ProviderCommand.json
--rw-rw-rw-  2.0 unx     3878 b- defN 23-Jul-13 15:29 opentf/schemas/opentestfactory.org/v1alpha1/ProviderConfig.json
--rw-rw-rw-  2.0 unx     4259 b- defN 23-Jul-13 15:29 opentf/schemas/opentestfactory.org/v1alpha1/ProviderResult.json
--rw-rw-rw-  2.0 unx     2910 b- defN 23-Jul-13 15:29 opentf/schemas/opentestfactory.org/v1alpha1/QualityGate.json
--rw-rw-rw-  2.0 unx     1182 b- defN 23-Jul-13 15:29 opentf/schemas/opentestfactory.org/v1alpha1/RetentionPolicy.json
--rw-rw-rw-  2.0 unx     6301 b- defN 23-Jul-13 15:29 opentf/schemas/opentestfactory.org/v1alpha1/SSHServiceConfig.json
--rw-rw-rw-  2.0 unx     2835 b- defN 23-Jul-13 15:29 opentf/schemas/opentestfactory.org/v1alpha1/ServiceConfig.json
--rw-rw-rw-  2.0 unx     2810 b- defN 23-Jul-13 15:29 opentf/schemas/opentestfactory.org/v1alpha1/Subscription.json
--rw-rw-rw-  2.0 unx     9899 b- defN 23-Jul-13 15:29 opentf/schemas/opentestfactory.org/v1alpha1/Workflow.json
--rw-rw-rw-  2.0 unx     1351 b- defN 23-Jul-13 15:29 opentf/schemas/opentestfactory.org/v1alpha1/WorkflowCanceled.json
--rw-rw-rw-  2.0 unx     1292 b- defN 23-Jul-13 15:29 opentf/schemas/opentestfactory.org/v1alpha1/WorkflowCompleted.json
--rw-rw-rw-  2.0 unx     1577 b- defN 23-Jul-13 15:29 opentf/schemas/opentestfactory.org/v1alpha1/WorkflowResult.json
--rw-rw-rw-  2.0 unx     2232 b- defN 23-Jul-13 15:29 opentf/schemas/opentestfactory.org/v1alpha2/Notification.json
--rw-rw-rw-  2.0 unx     6612 b- defN 23-Jul-13 15:29 opentf/schemas/opentestfactory.org/v1alpha2/SSHServiceConfig.json
--rw-rw-rw-  2.0 unx     4273 b- defN 23-Jul-13 15:29 opentf/schemas/opentestfactory.org/v1beta1/ExecutionCommand.json
--rw-rw-rw-  2.0 unx    10205 b- defN 23-Jul-13 15:29 opentf/schemas/opentestfactory.org/v1beta1/GeneratorResult.json
--rw-rw-rw-  2.0 unx     4581 b- defN 23-Jul-13 15:29 opentf/schemas/opentestfactory.org/v1beta1/ProviderCommand.json
--rw-rw-rw-  2.0 unx     4563 b- defN 23-Jul-13 15:29 opentf/schemas/opentestfactory.org/v1beta1/ProviderConfig.json
--rw-rw-rw-  2.0 unx     7494 b- defN 23-Jul-13 15:29 opentf/schemas/opentestfactory.org/v1beta1/ProviderResult.json
--rw-rw-rw-  2.0 unx     2850 b- defN 23-Jul-13 15:29 opentf/schemas/opentestfactory.org/v1beta1/ServiceConfig.json
--rw-rw-rw-  2.0 unx    15424 b- defN 23-Jul-13 15:29 opentf/schemas/opentestfactory.org/v1beta1/Workflow.json
--rw-rw-rw-  2.0 unx     3517 b- defN 23-Jul-13 15:29 opentf/schemas/opentestfactory.org/v1beta2/ServiceConfig.json
--rw-rw-rw-  2.0 unx     1579 b- defN 23-Jul-13 15:29 opentf/scripts/launch_java_service.sh
--rw-r--r--  2.0 unx    18703 b- defN 23-Jul-13 15:29 opentf/scripts/startup.py
--rw-r--r--  2.0 unx    19303 b- defN 23-Jul-13 15:29 opentf/toolkit/__init__.py
--rw-r--r--  2.0 unx    16121 b- defN 23-Jul-13 15:29 opentf/toolkit/channels.py
--rw-r--r--  2.0 unx     7314 b- defN 23-Jul-13 15:29 opentf/toolkit/core.py
--rw-rw-rw-  2.0 unx    11357 b- defN 23-Jul-13 15:29 opentf_toolkit_nightly-0.50.0.dev634.dist-info/LICENSE
--rw-r--r--  2.0 unx     1981 b- defN 23-Jul-13 15:29 opentf_toolkit_nightly-0.50.0.dev634.dist-info/METADATA
--rw-r--r--  2.0 unx       92 b- defN 23-Jul-13 15:29 opentf_toolkit_nightly-0.50.0.dev634.dist-info/WHEEL
--rw-r--r--  2.0 unx        7 b- defN 23-Jul-13 15:29 opentf_toolkit_nightly-0.50.0.dev634.dist-info/top_level.txt
--rw-rw-r--  2.0 unx     5343 b- defN 23-Jul-13 15:29 opentf_toolkit_nightly-0.50.0.dev634.dist-info/RECORD
-48 files, 279686 bytes uncompressed, 65278 bytes compressed:  76.7%
+Zip file size: 78234 bytes, number of entries: 52
+-rw-r--r--  2.0 unx    20247 b- defN 23-Jul-18 15:50 opentf/commons/__init__.py
+-rw-r--r--  2.0 unx    13194 b- defN 23-Jul-18 15:50 opentf/commons/auth.py
+-rw-r--r--  2.0 unx     3510 b- defN 23-Jul-18 15:50 opentf/commons/config.py
+-rw-r--r--  2.0 unx    18980 b- defN 23-Jul-18 15:50 opentf/commons/expressions.py
+-rw-r--r--  2.0 unx     5518 b- defN 23-Jul-18 15:50 opentf/commons/pubsub.py
+-rw-r--r--  2.0 unx     2404 b- defN 23-Jul-18 15:50 opentf/commons/schemas.py
+-rw-r--r--  2.0 unx     5521 b- defN 23-Jul-18 15:50 opentf/commons/selectors.py
+-rw-r--r--  2.0 unx        0 b- defN 23-Jul-18 15:50 opentf/schemas/__init__.py
+-rw-rw-rw-  2.0 unx     2105 b- defN 23-Jul-18 15:50 opentf/schemas/abac.opentestfactory.org/v1alpha1/Policy.json
+-rw-rw-rw-  2.0 unx     1230 b- defN 23-Jul-18 15:50 opentf/schemas/opentestfactory.org/v1alpha1/AgentRegistration.json
+-rw-rw-rw-  2.0 unx     1366 b- defN 23-Jul-18 15:50 opentf/schemas/opentestfactory.org/v1alpha1/AllureCollectorOutput.json
+-rw-rw-rw-  2.0 unx     1239 b- defN 23-Jul-18 15:50 opentf/schemas/opentestfactory.org/v1alpha1/ChannelHandlerHooks.json
+-rw-rw-rw-  2.0 unx     2174 b- defN 23-Jul-18 15:50 opentf/schemas/opentestfactory.org/v1alpha1/EventBusConfig.json
+-rw-rw-rw-  2.0 unx     2702 b- defN 23-Jul-18 15:50 opentf/schemas/opentestfactory.org/v1alpha1/ExecutionCommand.json
+-rw-rw-rw-  2.0 unx     1347 b- defN 23-Jul-18 15:50 opentf/schemas/opentestfactory.org/v1alpha1/ExecutionError.json
+-rw-rw-rw-  2.0 unx     3050 b- defN 23-Jul-18 15:50 opentf/schemas/opentestfactory.org/v1alpha1/ExecutionResult.json
+-rw-rw-rw-  2.0 unx     1754 b- defN 23-Jul-18 15:50 opentf/schemas/opentestfactory.org/v1alpha1/GeneratorCommand.json
+-rw-rw-rw-  2.0 unx     6633 b- defN 23-Jul-18 15:50 opentf/schemas/opentestfactory.org/v1alpha1/GeneratorResult.json
+-rw-rw-rw-  2.0 unx     3790 b- defN 23-Jul-18 15:50 opentf/schemas/opentestfactory.org/v1alpha1/Notification.json
+-rw-rw-rw-  2.0 unx     2803 b- defN 23-Jul-18 15:50 opentf/schemas/opentestfactory.org/v1alpha1/PluginMetadata.json
+-rw-rw-rw-  2.0 unx     2875 b- defN 23-Jul-18 15:50 opentf/schemas/opentestfactory.org/v1alpha1/ProviderCommand.json
+-rw-rw-rw-  2.0 unx     3878 b- defN 23-Jul-18 15:50 opentf/schemas/opentestfactory.org/v1alpha1/ProviderConfig.json
+-rw-rw-rw-  2.0 unx     4259 b- defN 23-Jul-18 15:50 opentf/schemas/opentestfactory.org/v1alpha1/ProviderResult.json
+-rw-rw-rw-  2.0 unx     2910 b- defN 23-Jul-18 15:50 opentf/schemas/opentestfactory.org/v1alpha1/QualityGate.json
+-rw-rw-rw-  2.0 unx     1182 b- defN 23-Jul-18 15:50 opentf/schemas/opentestfactory.org/v1alpha1/RetentionPolicy.json
+-rw-rw-rw-  2.0 unx     6301 b- defN 23-Jul-18 15:50 opentf/schemas/opentestfactory.org/v1alpha1/SSHServiceConfig.json
+-rw-rw-rw-  2.0 unx     2835 b- defN 23-Jul-18 15:50 opentf/schemas/opentestfactory.org/v1alpha1/ServiceConfig.json
+-rw-rw-rw-  2.0 unx     2810 b- defN 23-Jul-18 15:50 opentf/schemas/opentestfactory.org/v1alpha1/Subscription.json
+-rw-rw-rw-  2.0 unx     9899 b- defN 23-Jul-18 15:50 opentf/schemas/opentestfactory.org/v1alpha1/Workflow.json
+-rw-rw-rw-  2.0 unx     1351 b- defN 23-Jul-18 15:50 opentf/schemas/opentestfactory.org/v1alpha1/WorkflowCanceled.json
+-rw-rw-rw-  2.0 unx     1292 b- defN 23-Jul-18 15:50 opentf/schemas/opentestfactory.org/v1alpha1/WorkflowCompleted.json
+-rw-rw-rw-  2.0 unx     1577 b- defN 23-Jul-18 15:50 opentf/schemas/opentestfactory.org/v1alpha1/WorkflowResult.json
+-rw-rw-rw-  2.0 unx     2232 b- defN 23-Jul-18 15:50 opentf/schemas/opentestfactory.org/v1alpha2/Notification.json
+-rw-rw-rw-  2.0 unx     6612 b- defN 23-Jul-18 15:50 opentf/schemas/opentestfactory.org/v1alpha2/SSHServiceConfig.json
+-rw-rw-rw-  2.0 unx     4273 b- defN 23-Jul-18 15:50 opentf/schemas/opentestfactory.org/v1beta1/ExecutionCommand.json
+-rw-rw-rw-  2.0 unx    10205 b- defN 23-Jul-18 15:50 opentf/schemas/opentestfactory.org/v1beta1/GeneratorResult.json
+-rw-rw-rw-  2.0 unx     4581 b- defN 23-Jul-18 15:50 opentf/schemas/opentestfactory.org/v1beta1/ProviderCommand.json
+-rw-rw-rw-  2.0 unx     4563 b- defN 23-Jul-18 15:50 opentf/schemas/opentestfactory.org/v1beta1/ProviderConfig.json
+-rw-rw-rw-  2.0 unx     7494 b- defN 23-Jul-18 15:50 opentf/schemas/opentestfactory.org/v1beta1/ProviderResult.json
+-rw-rw-rw-  2.0 unx     2850 b- defN 23-Jul-18 15:50 opentf/schemas/opentestfactory.org/v1beta1/ServiceConfig.json
+-rw-rw-rw-  2.0 unx    15424 b- defN 23-Jul-18 15:50 opentf/schemas/opentestfactory.org/v1beta1/Workflow.json
+-rw-rw-rw-  2.0 unx     3517 b- defN 23-Jul-18 15:50 opentf/schemas/opentestfactory.org/v1beta2/ServiceConfig.json
+-rw-rw-rw-  2.0 unx     1579 b- defN 23-Jul-18 15:50 opentf/scripts/launch_java_service.sh
+-rw-r--r--  2.0 unx    18703 b- defN 23-Jul-18 15:50 opentf/scripts/startup.py
+-rw-r--r--  2.0 unx    19303 b- defN 23-Jul-18 15:50 opentf/toolkit/__init__.py
+-rw-r--r--  2.0 unx    16121 b- defN 23-Jul-18 15:50 opentf/toolkit/channels.py
+-rw-r--r--  2.0 unx     7314 b- defN 23-Jul-18 15:50 opentf/toolkit/core.py
+-rw-rw-rw-  2.0 unx    11357 b- defN 23-Jul-18 15:50 opentf_toolkit_nightly-0.50.0.dev637.dist-info/LICENSE
+-rw-r--r--  2.0 unx     1981 b- defN 23-Jul-18 15:50 opentf_toolkit_nightly-0.50.0.dev637.dist-info/METADATA
+-rw-r--r--  2.0 unx       92 b- defN 23-Jul-18 15:50 opentf_toolkit_nightly-0.50.0.dev637.dist-info/WHEEL
+-rw-r--r--  2.0 unx        7 b- defN 23-Jul-18 15:50 opentf_toolkit_nightly-0.50.0.dev637.dist-info/top_level.txt
+-rw-rw-r--  2.0 unx     5667 b- defN 23-Jul-18 15:50 opentf_toolkit_nightly-0.50.0.dev637.dist-info/RECORD
+52 files, 284611 bytes uncompressed, 68748 bytes compressed:  75.8%
```

## zipnote {}

```diff
@@ -1,13 +1,25 @@
 Filename: opentf/commons/__init__.py
 Comment: 
 
+Filename: opentf/commons/auth.py
+Comment: 
+
+Filename: opentf/commons/config.py
+Comment: 
+
 Filename: opentf/commons/expressions.py
 Comment: 
 
+Filename: opentf/commons/pubsub.py
+Comment: 
+
+Filename: opentf/commons/schemas.py
+Comment: 
+
 Filename: opentf/commons/selectors.py
 Comment: 
 
 Filename: opentf/schemas/__init__.py
 Comment: 
 
 Filename: opentf/schemas/abac.opentestfactory.org/v1alpha1/Policy.json
@@ -123,23 +135,23 @@
 
 Filename: opentf/toolkit/channels.py
 Comment: 
 
 Filename: opentf/toolkit/core.py
 Comment: 
 
-Filename: opentf_toolkit_nightly-0.50.0.dev634.dist-info/LICENSE
+Filename: opentf_toolkit_nightly-0.50.0.dev637.dist-info/LICENSE
 Comment: 
 
-Filename: opentf_toolkit_nightly-0.50.0.dev634.dist-info/METADATA
+Filename: opentf_toolkit_nightly-0.50.0.dev637.dist-info/METADATA
 Comment: 
 
-Filename: opentf_toolkit_nightly-0.50.0.dev634.dist-info/WHEEL
+Filename: opentf_toolkit_nightly-0.50.0.dev637.dist-info/WHEEL
 Comment: 
 
-Filename: opentf_toolkit_nightly-0.50.0.dev634.dist-info/top_level.txt
+Filename: opentf_toolkit_nightly-0.50.0.dev637.dist-info/top_level.txt
 Comment: 
 
-Filename: opentf_toolkit_nightly-0.50.0.dev634.dist-info/RECORD
+Filename: opentf_toolkit_nightly-0.50.0.dev637.dist-info/RECORD
 Comment: 
 
 Zip file comment:
```

## opentf/commons/__init__.py

```diff
@@ -10,49 +10,49 @@
 # distributed under the License is distributed on an "AS IS" BASIS,
 # WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 # See the License for the specific language governing permissions and
 # limitations under the License.
 
 """Helpers for the OpenTestFactory orchestrator"""
 
-from typing import Any, Dict, Iterable, List, Optional, Tuple, Union
+from typing import Any, Dict, List, Optional, Tuple, Union
 
-import argparse
-import csv
 import itertools
 import logging
-import json
 import os
 import sys
 
-from datetime import datetime
 from functools import wraps
-from logging.config import dictConfig
 from uuid import uuid4
 
 import jwt
 import yaml
 
-from flask import Flask, current_app, make_response, request, g
-from jsonschema import validate, ValidationError
-
-import requests
+from flask import Flask, current_app, make_response, request, g, Response
 
 from toposort import toposort, CircularDependencyError
 
-import opentf.schemas
+from .config import ConfigError, make_argparser, configure_logging
+from .auth import (
+    initialize_authn_authz,
+    get_user_accessible_namespaces,
+    is_user_authorized,
+)
+from .pubsub import make_event, publish, make_subscription, subscribe, unsubscribe
+from .schemas import validate_schema
 
 
 ########################################################################
 # Constants
 
-NOTIFICATION_LOGGER_EXCLUSIONS = 'eventbus'
 
 DEFAULT_NAMESPACE = 'default'
 
+# Schemas
+
 SERVICECONFIG = 'opentestfactory.org/v1beta2/ServiceConfig'
 SSHSERVICECONFIG = 'opentestfactory.org/v1alpha2/SSHServiceConfig'
 EVENTBUSCONFIG = 'opentestfactory.org/v1alpha1/EventBusConfig'
 PROVIDERCONFIG = 'opentestfactory.org/v1beta1/ProviderConfig'
 
 SUBSCRIPTION = 'opentestfactory.org/v1alpha1/Subscription'
 
@@ -78,15 +78,15 @@
 ALLURE_COLLECTOR_OUTPUT = 'opentestfactory.org/v1alpha1/AllureCollectorOutput'
 
 CHANNEL_HOOKS = 'opentestfactory.org/v1alpha1/ChannelHandlerHooks'
 
 QUALITY_GATE = 'opentestfactory.org/v1alpha1/QualityGate'
 RETENTION_POLICY = 'opentestfactory.org/v1alpha1/RetentionPolicy'
 
-POLICY = 'abac.opentestfactory.org/v1alpha1/Policy'
+# Misc. constants
 
 DEFAULT_HEADERS = {
     'Content-Type': 'application/json',
     'Strict-Transport-Security': 'max-age=31536000; includeSubdomains',
     'X-Frame-Options': 'SAMEORIGIN',
     'X-Content-Type-Options': 'nosniff',
     'Referrer-Policy': 'no-referrer',
@@ -123,33 +123,26 @@
     'RS384',  # RSASSA-PKCS1-v1_5 signature algorithm using SHA-384 hash algorithm
     'RS512',  # RSASSA-PKCS1-v1_5 signature algorithm using SHA-512 hash algorithm
     'PS256',  # RSASSA-PSS signature using SHA-256 and MGF1 padding with SHA-256
     'PS384',  # RSASSA-PSS signature using SHA-384 and MGF1 padding with SHA-384
     'PS512',  # RSASSA-PSS signature using SHA-512 and MGF1 padding with SHA-512
 ]
 
-READONLY_VERBS = ('get', 'watch', 'list')
-READWRITE_VERBS = ('create', 'delete', 'update', 'patch')
-
 ACCESSLOG_FORMAT = (
     '%(REMOTE_ADDR)s - %(REMOTE_USER)s '
     '"%(REQUEST_METHOD)s %(REQUEST_URI)s %(HTTP_VERSION)s" '
     '%(status)s %(bytes)s "%(HTTP_REFERER)s" "%(HTTP_USER_AGENT)s"'
 )
 
 DEBUG_LEVELS = {'CRITICAL', 'ERROR', 'WARNING', 'INFO', 'DEBUG', 'NOTSET'}
 
 ########################################################################
 # Config Helpers
 
 
-class ConfigError(Exception):
-    """Invalid configuration file."""
-
-
 def _add_securityheaders(resp):
     """Add DEFAULT_HEADERS to response."""
     for header, value in DEFAULT_HEADERS.items():
         resp.headers[header] = value
     return resp
 
 
@@ -157,386 +150,95 @@
     """Check if ABAC or RBAC is enabled for service."""
     return current_app and (
         'RBAC' in current_app.config['CONTEXT'].get('authorization_mode', [])
         or 'ABAC' in current_app.config['CONTEXT'].get('authorization_mode', [])
     )
 
 
+def _check_token(authz: str, context: Dict[str, Any]) -> Optional[Response]:
+    """Check token validity.
+
+    Token is checked against known trusted authorities and then against
+    `token_auth_file`, if any.
+
+    The thread-local object `g` is filled with a `payload` entry (the
+    token payload in JWT mode, `{"sub": "username"}` in ABAC mode) and
+    possibly a `namespaces` entry (in JWT mode).
+
+    # Required parameters
+
+    - authz: a string ('bearer xxxxxx')
+    - context: a dictionary
+
+    # Returned value
+
+    None if the the bearer token is valid.  A status response if the
+    token is invalid.
+    """
+    parts = authz.split()
+    if not parts or parts[0].lower() != 'bearer' or len(parts) != 2:
+        logging.error(authz)
+        return make_status_response('Unauthorized', 'Invalid Authorization header.')
+    for mode in context.get('authorization_mode', []) + ['JWT']:
+        if mode == 'JWT':
+            for i, pubkey in enumerate(context['trusted_keys']):
+                try:
+                    payload = jwt.decode(
+                        parts[1], pubkey[0], algorithms=ALLOWED_ALGORITHMS
+                    )
+                    logging.debug('Token signed by trusted key #%d', i)
+                    g.payload = payload
+                    g.namespaces = pubkey[1]
+                    return None
+                except ValueError as err:
+                    logging.error('Invalid trusted key #%d:', i)
+                    logging.error(err)
+                except jwt.InvalidAlgorithmError as err:
+                    logging.error(
+                        'Invalid algorithm while verifying token by trusted key #%d:', i
+                    )
+                    logging.error(err)
+                except jwt.InvalidTokenError as err:
+                    logging.debug('Token could not be verified by trusted key #%d:', i)
+                    logging.debug(err)
+        elif mode == 'ABAC':
+            for user in context.get('authorization_tokens', []):
+                if user[0] == parts[1]:
+                    g.payload = {'sub': user[2]}
+                    return None
+    return make_status_response('Unauthorized', 'Invalid JWT token.')
+
+
 def _get_debug_level(name: str) -> str:
     """Get service log level.
 
     Driven by environment variables.  If `{service name}_DEBUG_LEVEL` is
     defined, this value is used.  If not, if `DEBUG_LEVEL` is set, then
     it is used.  Otherwise, returns `INFO`.
 
     Value must be one of `CRITICAL`, `ERROR`, `WARNING`, `INFO`,
-    `DEBUG`, or `NOTSET`.
+    `DEBUG`, `TRACE`, or `NOTSET`.
 
     # Required parameter
 
     - name: a string, the service name
 
     # Returned value
 
     The requested log level if in the allowed values, `INFO` otherwise.
     """
     level = os.environ.get(
         f'{name.upper()}_DEBUG_LEVEL', os.environ.get('DEBUG_LEVEL', 'INFO')
     )
+    if level == 'TRACE':
+        level = 'NOTSET'
     return level if level in DEBUG_LEVELS else 'INFO'
 
 
 ########################################################################
-# Config files internal helpers
-
-
-def _read_key_files(items: Iterable[str], context: Dict[str, Any]) -> None:
-    """Read a series of files.
-
-    Keys are loaded and stored in the context's `trusted_keys` entry as
-    a list of `(key value, list of namespaces)` tuples.
-
-    Uses `context['authorization_trustedkeys']` to map keys to
-    namespaces (assuming `default` for keys not present in the
-    aforementioned entry).
-
-    # Required parameters
-
-    - items: an iterable of strings
-    - context: a dictionary
-
-    Items are either fully-qualified file names or fully-qualified
-    directory name ending with '/*'.
-
-    For example:
-
-    - /etc/opentf/a_public_key
-    - /etc/opentf/dept_a/*
-    - /etc/opentf/another_public_key
-    - /etc/opentf/dept_b/*
-
-    # Raised exceptions
-
-    Raises _ConfigError_ if no key is found.
-    """
-    files = []
-    for item in items:
-        if item.endswith('/*'):
-            files += [
-                f'{item[:-1]}{file}'
-                for file in os.listdir(item[:-2])
-                if not file.startswith('.')
-            ]
-        else:
-            files.append(item)
-    auths = {}
-    for auth in context.get('authorization_trustedkeys', []):
-        if len(auth) >= 4:
-            auths[auth[0]] = list(map(str.strip, auth[3].split(',')))
-    keys = []
-    summary_keys = []
-    found_files = []
-    for i, keyfile in enumerate(files):
-        try:
-            with open(keyfile, 'r', encoding='utf-8') as key:
-                description = f'trusted key #{i} ({keyfile})'
-                namespaces = auths.get(keyfile, ['default'])
-                logging.debug('Reading %s', description)
-                keys.append((key.read(), namespaces))
-                summary_keys.append((description, namespaces))
-                found_files.append(keyfile)
-        except Exception as err:
-            logging.error(
-                'Error while reading trusted key #%d (%s), skipping:', i, keyfile
-            )
-            logging.error(err)
-
-    if not keys:
-        raise ConfigError(
-            f'Could not find at least one valid trusted key among {files}, aborting.'
-        )
-
-    for auth in context.get('authorization_trustedkeys', []):
-        if auth[0] not in found_files:
-            logging.error(
-                'Could not find key "%s" specified in trusted keys authorization file among trusted keys %s, skipping.',
-                auth[0],
-                str(files),
-            )
-
-    logging.debug('Trusted keys/namespaces mapping: %s', summary_keys)
-    context['trusted_keys'] = keys
-
-
-def _read_authorization_policy_file(file: str, context: Dict[str, Any]) -> None:
-    """Read ABAC authorization policy file.
-
-    Policy file is a JSONL file, of form:
-
-    ```json
-    {"apiVersion": "abac.opentestfactory.org/v1alpha1", "kind": "Policy", "spec": {"user": "alice", "namespace": "*", "resource": "*", "apiGroup": "*"}}
-    ...
-    ```
-
-    # Required parameters
-
-    - file: a string
-    - context: a dictionary
-
-    # Returned value
-
-    None
-
-    # Raised exceptions
-
-    Raises _ConfigError_ if the specified file is not a JSONL file.
-    """
-    if not os.path.exists(file):
-        raise ConfigError(f'Authorization policy file "{file}" does not exist.')
-    try:
-        with open(file, 'r', encoding='utf-8') as f:
-            context['authorization_policies'] = [
-                json.loads(l) for l in f.read().splitlines() if l
-            ]
-        for policy in context['authorization_policies']:
-            valid, extra = validate_schema(POLICY, policy)
-            if not valid:
-                raise ConfigError(f'Invalid policy file "{file}": {extra}.')
-    except Exception as err:
-        raise ConfigError(f'Could not read policy file "{file}": {err}.')
-
-
-def _read_trustedkeys_auth_file(file: str, context: Dict[str, Any]) -> None:
-    """Read trustedkeys file.
-
-    Trusted keys auth file is of form:
-
-    ```text
-    key,name,"group1,group2,group3","namespace_1,namespace_2"
-    ```
-
-    The first 2 columns are required, the remaining columns are
-    optional.
-
-    # Raised exceptions
-
-    Raises _ConfigError_ if the specified token file is invalid.
-    """
-    if not os.path.exists(file):
-        raise ConfigError(f'Trusted keys authorization file "{file}" does not exist.')
-    try:
-        with open(file, 'r', encoding='utf-8') as f:
-            context['authorization_trustedkeys'] = list(
-                filter(None, csv.reader(f, delimiter=',', skipinitialspace=True))
-            )
-        for entry in context['authorization_trustedkeys']:
-            if len(entry) < 2:
-                raise ConfigError(
-                    f'Entries in trusted keys authorization file "{file}" must have at least 2 elements: {entry}.'
-                )
-        if len(context['authorization_trustedkeys']) != len(
-            set(x[0] for x in context['authorization_trustedkeys'])
-        ):
-            raise ConfigError(
-                f'Duplicated entries in trusted keys authorization file "{file}".'
-            )
-        if not context['authorization_trustedkeys']:
-            raise ConfigError(
-                f'No entry found in trusted keys authorization file "{file}".'
-            )
-    except Exception as err:
-        raise ConfigError(
-            f'Could not read trusted keys authorization file "{file}": {err}.'
-        )
-
-
-def _read_token_auth_file(file: str, context: Dict[str, Any]) -> None:
-    """Read token file.
-
-    Static token file is of form:
-
-    ```text
-    token,user,uid,"group1,group2,group3"
-    ```
-
-    The first 3 columns are required, the remaining columns are
-    optional.
-
-    # Raised exceptions
-
-    Raises _ConfigError_ if the specified token file is invalid.
-    """
-    if not os.path.exists(file):
-        raise ConfigError(f'Token authorization file "{file}" does not exist.')
-    try:
-        with open(file, 'r', encoding='utf-8') as f:
-            context['authorization_tokens'] = list(
-                filter(None, csv.reader(f, delimiter=',', skipinitialspace=True))
-            )
-        for entry in context['authorization_tokens']:
-            if len(entry) < 3:
-                raise ConfigError(
-                    f'Entries in token authorization file "{file}" must have at least 3 elements: {entry}'
-                )
-        if not context['authorization_tokens']:
-            raise ConfigError(f'No entry found in token authorization file "{file}".')
-    except Exception as err:
-        raise ConfigError(f'Could not read token authorization file "{file}": {err}.')
-
-
-def _initialize_authn_authz(args, context: Dict[str, Any]) -> None:
-    """Initialize authn & authz
-
-    Handles the following service parameters:
-
-    - `--trusted-authorities`
-    - `--enable-insecure-login`
-    - `--insecure-bind-address`
-    - `--authorization-mode` (ABAC, RBAC)
-
-    The `context` is updated accordingly.
-
-    # Required parameters
-
-    - args: an argparse result
-    - context: a dictionary
-    """
-    abac = rbac = False
-    if args.trusted_authorities:
-        context['trusted_authorities'] = [
-            ta.strip() for ta in args.trusted_authorities.split(',')
-        ]
-    if args.authorization_mode:
-        context['authorization_mode'] = [
-            am.strip() for am in args.authorization_mode.split(',')
-        ]
-        abac = 'ABAC' in context['authorization_mode']
-        rbac = 'RBAC' in context['authorization_mode']
-        if abac and rbac:
-            raise ConfigError(
-                'Cannot specify both ABAC and RBAC as authorization mode.'
-            )
-        if abac:
-            if not args.authorization_policy_file:
-                raise ConfigError('ABAC requires an authorization policy file.')
-            if not args.token_auth_file:
-                raise ConfigError('ABAC requires a token authentication file.')
-            _read_authorization_policy_file(args.authorization_policy_file, context)
-            _read_token_auth_file(args.token_auth_file, context)
-
-        if rbac:
-            raise ConfigError('RBAC not supported yet.')
-
-    if args.enable_insecure_login:
-        context['enable_insecure_login'] = True
-    if 'enable_insecure_login' not in context:
-        context['enable_insecure_login'] = False
-    if 'insecure_bind_address' not in context:
-        context['insecure_bind_address'] = args.insecure_bind_address
-    if args.trustedkeys_auth_file:
-        _read_trustedkeys_auth_file(args.trustedkeys_auth_file, context)
-    _read_key_files(context.get('trusted_authorities', []), context)
-
-
-########################################################################
-# request authorizers helpers
-
-USERIDS_RULES_CACHE = {}
-USERIDS_NAMESPACES_CACHE = {}
-
-
-def _in_group(user_id, group):
-    tokens = current_app.config['CONTEXT'].get('authorization_tokens')
-    if group is not None and tokens is not None:
-        for entry in tokens:
-            if entry[2] == user_id and len(entry) > 3:
-                return group in map(str.strip, entry[3].split(','))
-    return False
-
-
-def _cache_userid_rules(user_id: str) -> None:
-    USERIDS_RULES_CACHE[user_id] = [
-        policy['spec']
-        for policy in current_app.config['CONTEXT']['authorization_policies']
-        if policy['spec'].get('user') == user_id
-        or _in_group(user_id, policy['spec'].get('group'))
-    ]
-
-
-def _cache_userid_namespaces(user_id: str) -> None:
-    USERIDS_NAMESPACES_CACHE[user_id] = {
-        rule['namespace']
-        for rule in USERIDS_RULES_CACHE[user_id]
-        if 'namespace' in rule
-    }
-    # nss = USERIDS_NAMESPACES_CACHE[user_id] = set()
-    # for rule in USERIDS_RULES_CACHE[user_id]:
-    #     if rule.get('namespace'):
-    #         nss.add(rule['namespace'])
-
-
-def _is_authorized(payload, resource: str, verb: str) -> bool:
-    """Check if resource access is authorized, disregarding namespace."""
-    if 'namespaces' in g:
-        return True
-    user_id = payload['sub']
-    if user_id not in USERIDS_RULES_CACHE:
-        _cache_userid_rules(user_id)
-
-    return any(
-        verb in READONLY_VERBS if rule.get('readonly') else True
-        for rule in USERIDS_RULES_CACHE[user_id]
-        if rule['resource'] in (resource, '*')
-    )
-
-
-def _rule_gives_permission(
-    rule: Dict[str, Any],
-    namespace: str,
-    resource: Optional[str] = None,
-    verb: Optional[str] = None,
-) -> bool:
-    """Check access."""
-    if rule['namespace'] in ('*', namespace) and rule['resource'] in (
-        resource,
-        '*',
-    ):
-        if verb in READONLY_VERBS and rule.get('readonly'):
-            return True
-        if not rule.get('readonly'):
-            return True
-    return False
-
-
-def _get_accessible_namespaces_for_user(
-    resource: Optional[str] = None, verb: Optional[str] = None
-) -> List[str]:
-    """Check access granted by rules.
-
-    # Returned value
-
-    A list of namespaces or `['*']`.
-    """
-    user = g.payload['sub']
-    if user not in USERIDS_RULES_CACHE:
-        _cache_userid_rules(user)
-    if user not in USERIDS_NAMESPACES_CACHE:
-        _cache_userid_namespaces(user)
-
-    if resource and verb:
-        namespaces = {
-            namespace
-            for namespace in USERIDS_NAMESPACES_CACHE[user]
-            for rule in USERIDS_RULES_CACHE[user]
-            if _rule_gives_permission(rule, namespace, resource, verb)
-        }
-    else:
-        namespaces = USERIDS_NAMESPACES_CACHE[user]
-
-    return ['*'] if '*' in namespaces else list(namespaces)
 
 
 def list_accessible_namespaces(
     resource: Optional[str] = None, verb: Optional[str] = None
 ) -> List[str]:
     """Get the accessible namespaces.
 
@@ -553,15 +255,17 @@
     accessible.
     """
     if not g or g.get('insecure_login'):
         return ['*']
     if 'namespaces' in g:
         return list(g.namespaces)
     if 'payload' in g:
-        return _get_accessible_namespaces_for_user(resource, verb)
+        return get_user_accessible_namespaces(
+            g.payload['sub'], current_app.config['CONTEXT'], resource, verb
+        )
     return []
 
 
 def can_use_namespace(
     namespace: str, resource: Optional[str] = None, verb: Optional[str] = None
 ) -> bool:
     """Check if namespace is accessible for current request.
@@ -608,76 +312,29 @@
         @wraps(function)
         def wrapper(*args, **kwargs):
             if not _is_authorizer_required() or not g or g.get('insecure_login'):
                 return function(*args, **kwargs)
             payload = g.get('payload')
             if not payload:
                 return make_status_response('Unauthorized', 'No JWT payload.')
-            if not _is_authorized(payload, resource, verb):
+            user = payload['sub']
+            if not 'namespaces' in g and not is_user_authorized(
+                user, resource, verb, current_app.config['CONTEXT']
+            ):
                 return make_status_response(
                     'Forbidden',
-                    f'User {payload["sub"]} is not authorized to {verb} {resource}.',
+                    f'User {user} is not authorized to {verb} {resource}.',
                 )
             return function(*args, **kwargs)
 
         return wrapper
 
     return inner
 
 
-def _check_token(authz: str, context: Dict[str, Any]):
-    """Check token validity.
-
-    Token is checked against known trusted authorities and then against
-    `token_auth_file`, if any.
-
-    # Required parameters
-
-    - authz: a string ('bearer xxxxxx')
-    - context: a dictionary
-
-    # Returned value
-
-    None if the the bearer token is valid.  A status response if the
-    token is invalid.
-    """
-    parts = authz.split()
-    if not parts or parts[0].lower() != 'bearer' or len(parts) != 2:
-        logging.error(authz)
-        return make_status_response('Unauthorized', 'Invalid Authorization header.')
-    for mode in context.get('authorization_mode', []) + ['JWT']:
-        if mode == 'JWT':
-            for i, pubkey in enumerate(context['trusted_keys']):
-                try:
-                    payload = jwt.decode(
-                        parts[1], pubkey[0], algorithms=ALLOWED_ALGORITHMS
-                    )
-                    logging.debug('Token signed by trusted key #%d', i)
-                    g.payload = payload
-                    g.namespaces = pubkey[1]
-                    return None
-                except ValueError as err:
-                    logging.error('Invalid trusted key #%d:', i)
-                    logging.error(err)
-                except jwt.InvalidAlgorithmError as err:
-                    logging.error(
-                        'Invalid algorithm while verifying token by trusted key #%d:', i
-                    )
-                    logging.error(err)
-                except jwt.InvalidTokenError as err:
-                    logging.debug('Token could not be verified by trusted key #%d:', i)
-                    logging.debug(err)
-        elif mode == 'ABAC':
-            for user in context.get('authorization_tokens', []):
-                if user[0] == parts[1]:
-                    g.payload = {'sub': user[2]}
-                    return None
-    return make_status_response('Unauthorized', 'Invalid JWT token.')
-
-
 def _make_authenticator(context: Dict[str, Any]):
     """Make an authenticator function tied to context."""
 
     def inner():
         """Ensure the incoming request is authenticated.
 
         If from localhost, allow.
@@ -748,83 +405,31 @@
         self.silent = silent
         super().__init__()
 
     def emit(self, record):
         if request and 'workflow_id' in g:
             try:
                 publish(
-                    {
-                        'apiVersion': 'opentestfactory.org/v1alpha1',
-                        'kind': 'Notification',
-                        'metadata': {
+                    make_event(
+                        NOTIFICATION,
+                        metadata={
                             'name': 'log notification',
                             'workflow_id': g.workflow_id,
                         },
-                        'spec': {'logs': [self.format(record)]},
-                    },
+                        spec={'logs': [self.format(record)]},
+                    ),
                     current_app.config['CONTEXT'],
                 )
             except Exception:
                 if not self.silent:
                     print(
                         f'{record.name}: Could not send notification to workflow {g.workflow_id}.'
                     )
 
 
-def _make_argparser(description: str, configfile: str):
-    parser = argparse.ArgumentParser(description=description)
-    parser.add_argument(
-        '--config', help=f'alternate config file (default to {configfile})'
-    )
-    parser.add_argument('--context', help='alternative context')
-    parser.add_argument('--host', help='alternative host')
-    parser.add_argument('--port', help='alternative port')
-    parser.add_argument(
-        '--ssl_context', '--ssl-context', help='alternative ssl context'
-    )
-    parser.add_argument(
-        '--trusted_authorities',
-        '--trusted-authorities',
-        help='alternative trusted authorities',
-    )
-    parser.add_argument(
-        '--enable_insecure_login',
-        '--enable-insecure-login',
-        action='store_true',
-        help='enable insecure login (disabled by default)',
-    )
-    parser.add_argument(
-        '--insecure_bind_address',
-        '--insecure-bind-address',
-        help='insecure bind address (127.0.0.1 by default)',
-        default='127.0.0.1',
-    )
-    parser.add_argument(
-        '--authorization_mode',
-        '--authorization-mode',
-        help='authorization mode, JWT without RBAC if unspecified',
-    )
-    parser.add_argument(
-        '--authorization_policy_file',
-        '--authorization-policy-file',
-        help='authorization policies for ABAC',
-    )
-    parser.add_argument(
-        '--token_auth_file',
-        '--token-auth-file',
-        help='authenticated users for ABAC and RBAC',
-    )
-    parser.add_argument(
-        '--trustedkeys_auth_file',
-        '--trustedkeys-auth-file',
-        help='authenticated trusted keys for ABAC and RBAC',
-    )
-    return parser
-
-
 def make_app(
     name: str,
     description: str,
     configfile: str,
     schema: Optional[str] = None,
     defaultcontext: Optional[Dict[str, Any]] = None,
 ) -> Flask:
@@ -851,43 +456,18 @@
     also a dictionary.
 
     # Raised Exception
 
     A _ConfigError_ exception is raised if the context is not found or
     if the config file is invalid.
     """
-    parser = _make_argparser(description, configfile)
+    parser = make_argparser(description, configfile)
     args = parser.parse_args()
 
-    logging_conf = {
-        'version': 1,
-        'formatters': {
-            'default': {
-                'format': f'[%(asctime)s] %(levelname)s in {name}: %(message)s',
-            }
-        },
-        'handlers': {
-            'wsgi': {
-                'class': 'logging.StreamHandler',
-                'stream': 'ext://flask.logging.wsgi_errors_stream',
-                'formatter': 'default',
-            },
-        },
-        'root': {
-            'level': _get_debug_level(name),
-            'handlers': ['wsgi'],
-        },
-    }
-    if name not in NOTIFICATION_LOGGER_EXCLUSIONS:
-        logging_conf['handlers']['eventbus'] = {
-            'class': 'opentf.commons.EventbusLogger',
-            'formatter': 'default',
-        }
-        logging_conf['root']['handlers'] += ['eventbus']
-    dictConfig(logging_conf)
+    configure_logging(name, _get_debug_level(name))
 
     app = Flask(name)
     try:
         if args.config is None and not os.path.isfile(configfile):
             if args.context:
                 raise ConfigError(
                     'Cannot specify a context with default configuration.'
@@ -921,15 +501,15 @@
         context['host'] = args.host
     if args.port:
         context['port'] = args.port
     if args.ssl_context:
         context['ssl_context'] = args.ssl_context
 
     try:
-        _initialize_authn_authz(args, context)
+        initialize_authn_authz(args, context)
     except ConfigError as err:
         app.logger.error(err)
         sys.exit(2)
 
     app.config['CONTEXT'] = context
     app.config['CONFIG'] = config
     app.config['DEBUG_LEVEL'] = os.environ.get('DEBUG_LEVEL', 'INFO')
@@ -944,99 +524,17 @@
 
 def make_uuid():
     """Generate a new uuid as a string."""
     return str(uuid4())
 
 
 ########################################################################
-# JSON Schema Helpers
-
-_schemas = {}
-
-SCHEMAS_ROOT_DIRECTORY = list(opentf.schemas.__path__)[0]
-
-
-def get_schema(name: str) -> Dict[str, Any]:
-    """Get specified schema.
-
-    # Required parameters
-
-    - name: a string, the schema name (its kind)
-
-    # Returned value
-
-    A _schema_.  A schema is a dictionary.
-
-    # Raised exceptions
-
-    If an error occurs while reading the schema, the initial exception
-    is logged and raised again.
-    """
-    if name not in _schemas:
-        try:
-            with open(
-                os.path.join(SCHEMAS_ROOT_DIRECTORY, f'{name}.json'),
-                'r',
-                encoding='utf-8',
-            ) as schema:
-                _schemas[name] = json.loads(schema.read())
-        except Exception as err:
-            logging.error('Could not read schema %s: %s', name, err)
-            raise
-    return _schemas[name]
-
-
-def validate_schema(schema, instance) -> Tuple[bool, Any]:
-    """Return True if instance validates schema.
-
-    # Required parameters
-
-    - schema: a string, the schema name (its kind)
-    - instance: a dictionary
-
-    # Returned value
-
-    A (bool, Optional[str]) pair.  If `instance` is a valid instance of
-    `schema`, returns `(True, None)`.  If not, returns `(False, error)`.
-
-    # Raised exceptions
-
-    If an error occurs while reading the schema, the initial exception
-    is logged and raised again.
-    """
-    try:
-        validate(schema=get_schema(schema), instance=instance)
-    except ValidationError as err:
-        return False, err
-    return True, None
-
-
-########################################################################
 # API Server Helpers
 
 
-def make_event(schema: str, **kwargs) -> Dict[str, Any]:
-    """Return a new event dictionary.
-
-    # Required parameters
-
-    - schema: a string
-
-    # Optional parameters
-
-    A series of key=values
-
-    # Returned value
-
-    A dictionary.
-    """
-    apiversion, kind = schema.rsplit('/', 1)
-    return {'apiVersion': apiversion, 'kind': kind, **kwargs}
-
-
 def make_status_response(
     reason: str, message: str, details: Optional[Dict[str, Any]] = None
 ):
     """Return a new status response object.
 
     # Required parameters
 
@@ -1152,160 +650,7 @@
                 else:
                     jobs[job] = {needs}
             else:
                 jobs[job] = set()
         return list(itertools.chain.from_iterable(toposort(jobs)))
     except CircularDependencyError:
         return None
-
-
-########################################################################
-# Publishers & Subscribers Helpers
-
-
-def make_subscription(
-    name: str, selector: Dict[str, Any], target: str, context: Dict[str, Any]
-) -> Dict[str, Any]:
-    """Generate a subscription manifest.
-
-    # Required parameter
-
-    - name: a string
-    - selector: a dictionary
-    - target: a string
-    - context: a dictionary
-
-    # Returned value
-
-    A _subscription manifest_.  A subscription manifest is a dictionary
-    with the following entries:
-
-    - apiVersion: a string
-    - kind: a string
-    - metadata: a dictionary
-    - spec: a dictionary
-
-    `metadata` has two entries: `name` and `timestamp`.
-
-    `spec` has two entries: `selector` and `subscriber`.
-    """
-    protocol = 'https' if context.get('ssl_context') != 'disabled' else 'http'
-    hostname = context['eventbus'].get('hostname', context['host'])
-    subscriber = {'endpoint': f'{protocol}://{hostname}:{context["port"]}/{target}'}
-    return {
-        'apiVersion': 'opentestfactory.org/v1alpha1',
-        'kind': 'Subscription',
-        'metadata': {'name': name, 'creationTimestamp': datetime.now().isoformat()},
-        'spec': {'selector': selector, 'subscriber': subscriber},
-    }
-
-
-def subscribe(
-    kind: str,
-    target: str,
-    app,
-    labels: Optional[Dict[str, Any]] = None,
-    fields: Optional[Dict[str, Any]] = None,
-) -> str:
-    """Subscribe on specified endpoint.
-
-    `kind` is of form `[apiVersion/]kind`.
-
-    # Required parameters
-
-    - kind: a string
-    - target: a string
-    - app: a flask app
-
-    # Optional parameters
-
-    - labels: a dictionary
-    - fields: a dictionary
-
-    # Returned value
-
-    A _uuid_ (a string).
-
-    # Raised exceptions
-
-    Raise a _SystemExit_ exception (with exit code 1) if the
-    subscription fails.
-    """
-    if '/' in kind:
-        apiversion, kind = kind.rsplit('/', 1)
-        if fields is None:
-            fields = {}
-        fields['apiVersion'] = apiversion
-    selector: Dict[str, Any] = {'matchKind': kind}
-    if labels:
-        selector['matchLabels'] = labels
-    if fields:
-        selector['matchFields'] = fields
-    context = app.config['CONTEXT']
-    try:
-        response = requests.post(
-            context['eventbus']['endpoint'] + '/subscriptions',
-            json=make_subscription(
-                app.name, selector=selector, target=target, context=context
-            ),
-            headers={'Authorization': f'Bearer {context["eventbus"]["token"]}'},
-            verify=not context['eventbus'].get('insecure-skip-tls-verify', False),
-        )
-    except Exception as err:
-        app.logger.error('Could not subscribe to eventbus: %s.', err)
-        sys.exit(1)
-
-    if response.status_code == 201:
-        return response.json()['details']['uuid']
-
-    app.logger.error(
-        'Could not subscribe to eventbus: got status %d: %s.',
-        response.status_code,
-        response.text,
-    )
-    sys.exit(1)
-
-
-def unsubscribe(subscription_id: str, app) -> requests.Response:
-    """Cancel specified subscription
-
-    #  Required parameters
-
-    - subscription_id: a string (an uuid)
-    - app: a flask app
-
-    # Returned value
-
-    A `requests.Response` object.
-    """
-    context = app.config['CONTEXT']
-    return requests.delete(
-        context['eventbus']['endpoint'] + '/subscriptions/' + subscription_id,
-        headers={'Authorization': f'Bearer {context["eventbus"]["token"]}'},
-        verify=not context['eventbus'].get('insecure-skip-tls-verify', False),
-    )
-
-
-def publish(publication: Any, context: Dict[str, Any]) -> requests.Response:
-    """Publish publication on specified endpoint.
-
-    If `publication` is a dictionary, and if it has a `metadata` entry,
-    a `creationTimestamp` sub-entry will be created (or overwritten if
-    it already exists).
-
-    # Required parameters
-
-    - publication: an object
-    - context: a dictionary
-
-    # Returned value
-
-    A `requests.Response` object.
-    """
-    if isinstance(publication, dict) and 'metadata' in publication:
-        publication['metadata']['creationTimestamp'] = datetime.now().isoformat()
-    return requests.post(
-        context['eventbus']['endpoint'] + '/publications',
-        json=publication,
-        headers={'Authorization': f'Bearer {context["eventbus"]["token"]}'},
-        verify=not context['eventbus'].get('insecure-skip-tls-verify', False),
-    )
```

## Comparing `opentf_toolkit_nightly-0.50.0.dev634.dist-info/LICENSE` & `opentf_toolkit_nightly-0.50.0.dev637.dist-info/LICENSE`

 * *Files identical despite different names*

## Comparing `opentf_toolkit_nightly-0.50.0.dev634.dist-info/METADATA` & `opentf_toolkit_nightly-0.50.0.dev637.dist-info/METADATA`

 * *Files 4% similar despite different names*

```diff
@@ -1,10 +1,10 @@
 Metadata-Version: 2.1
 Name: opentf-toolkit-nightly
-Version: 0.50.0.dev634
+Version: 0.50.0.dev637
 Summary: OpenTestFactory Orchestrator Toolkit
 Home-page: https://gitlab.com/henixdevelopment/open-source/opentestfactory/python-toolkit
 Author: Martin Lafaix
 Author-email: mlafaix@henix.com
 Maintainer: Henix
 Maintainer-email: opentestfactory@henix.com
 License: Apache Software License (https://www.apache.org/licenses/LICENSE-2.0)
```

## Comparing `opentf_toolkit_nightly-0.50.0.dev634.dist-info/RECORD` & `opentf_toolkit_nightly-0.50.0.dev637.dist-info/RECORD`

 * *Files 7% similar despite different names*

```diff
@@ -1,9 +1,13 @@
-opentf/commons/__init__.py,sha256=jvKY6wYhxY95ySPKPwNApPAZ9yxx19UHode6WI2rA4o,40272
+opentf/commons/__init__.py,sha256=dZSxwZ9sVGaIsn1P5GiDij2vj65oXLnI0ZDqBjCgFCE,20247
+opentf/commons/auth.py,sha256=39nVZdoiHCLeTztT9LTl5oRwBkzIn1ax-icdsul43Ak,13194
+opentf/commons/config.py,sha256=lvxacmFxxQ8Va0qepx-ld7taCpjOr4l-NjDBOTrzrE4,3510
 opentf/commons/expressions.py,sha256=geFdZeHGB-l0IEGImS2oHbhqJhMxXaHSAknFqWrqBgs,18980
+opentf/commons/pubsub.py,sha256=nDUpK4aPESTBmrxnCRtWyL4Uyz--HCzjAUm69Nm8Zfo,5518
+opentf/commons/schemas.py,sha256=CZgaGAyyNyXByeGDlEVbfIcHZZnjR7vOWMBV1QvlZgw,2404
 opentf/commons/selectors.py,sha256=yj7Os7_8osvOssKUxi8d4tpKSMKBAa5hM81TWKjIADI,5521
 opentf/schemas/__init__.py,sha256=47DEQpj8HBSa-_TImW-5JCeuQeRkm5NMpJWZG3hSuFU,0
 opentf/schemas/abac.opentestfactory.org/v1alpha1/Policy.json,sha256=JXsfNAPSEYggeyaDutSQBeG38o4Bmcr70dPLWWeqIh8,2105
 opentf/schemas/opentestfactory.org/v1alpha1/AgentRegistration.json,sha256=NQykqU-lKE8LtBhBiFUcpVJq00MRG6dZsoM1xedx6uQ,1230
 opentf/schemas/opentestfactory.org/v1alpha1/AllureCollectorOutput.json,sha256=-L9DDWA0A4x54bPMn4m6Qwi2tf2nHvzIPFOElTjaVck,1366
 opentf/schemas/opentestfactory.org/v1alpha1/ChannelHandlerHooks.json,sha256=6K6m9praw_f2biCMHfTsHPYia5z2jq10dciRLqf3ogI,1239
 opentf/schemas/opentestfactory.org/v1alpha1/EventBusConfig.json,sha256=2aIYtA07qRoauKNy-MH25Kzg1l1Q1fjY9_4YIvlyYgw,2174
@@ -37,12 +41,12 @@
 opentf/schemas/opentestfactory.org/v1beta1/Workflow.json,sha256=QZ8mM9PhzsI9gTmwmKTWYNoRn--rtcM3L0PzgnPBfMU,15424
 opentf/schemas/opentestfactory.org/v1beta2/ServiceConfig.json,sha256=rEvK2YWL5lG94_qYgR_GnLWNsaQhaQ-2kuZdWJr5NnY,3517
 opentf/scripts/launch_java_service.sh,sha256=FRYrQD704VWLGXQ3QI-M3m77olXexB0vVEwzyiKLkxc,1579
 opentf/scripts/startup.py,sha256=46UL6uCBXId3z3009bIIOD-inFEKrgg3allNQQYFIZs,18703
 opentf/toolkit/__init__.py,sha256=s2HZLnfWPIvkfLWboWPT4JwfBNH-8kZd9XMsZ5Tibsk,19303
 opentf/toolkit/channels.py,sha256=caUaZIRHp9D4BoJRtFug-M6tsjxrp3TDPaBxPlPghos,16121
 opentf/toolkit/core.py,sha256=wLu2fvcahExR6MYAwzsLJnG-tdO0wg6_LZ2NxHeUdvA,7314
-opentf_toolkit_nightly-0.50.0.dev634.dist-info/LICENSE,sha256=xx0jnfkXJvxRnG63LTGOxlggYnIysveWIZ6H3PNdCrQ,11357
-opentf_toolkit_nightly-0.50.0.dev634.dist-info/METADATA,sha256=c6Z415CgCLrb01_VBG0TDw3Kga8m13iElAV8o3xI31g,1981
-opentf_toolkit_nightly-0.50.0.dev634.dist-info/WHEEL,sha256=pkctZYzUS4AYVn6dJ-7367OJZivF2e8RA9b_ZBjif18,92
-opentf_toolkit_nightly-0.50.0.dev634.dist-info/top_level.txt,sha256=_gPuE6GTT6UNXy1DjtmQSfCcZb_qYA2vWmjg7a30AGk,7
-opentf_toolkit_nightly-0.50.0.dev634.dist-info/RECORD,,
+opentf_toolkit_nightly-0.50.0.dev637.dist-info/LICENSE,sha256=xx0jnfkXJvxRnG63LTGOxlggYnIysveWIZ6H3PNdCrQ,11357
+opentf_toolkit_nightly-0.50.0.dev637.dist-info/METADATA,sha256=F481BJWvwS6oHLFARzXQXOwuJqE5RXWOHsoevRWj5dE,1981
+opentf_toolkit_nightly-0.50.0.dev637.dist-info/WHEEL,sha256=pkctZYzUS4AYVn6dJ-7367OJZivF2e8RA9b_ZBjif18,92
+opentf_toolkit_nightly-0.50.0.dev637.dist-info/top_level.txt,sha256=_gPuE6GTT6UNXy1DjtmQSfCcZb_qYA2vWmjg7a30AGk,7
+opentf_toolkit_nightly-0.50.0.dev637.dist-info/RECORD,,
```

